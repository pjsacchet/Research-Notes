# Threads

### Symmetric Multiprocessing
Initial Windows design choices make it so Windows runs well on multiprocessor systems. Windows is by definition a symmetric multiprocessing (SMP) OS, i.e., there is no 'master' processor for running kernel code vs. user code. Asymmetric Processing (ASMP) however does split processor cores to have one dedicated to OS system calls (a 'master') while the remaining cores serve to service user threads/code. There are four types of multiprocessor systems that Windows supports:

1. Multicore - Real physical cores. Windows' original SMP code treats cores as discrete processors. 
2. Simultaneous Mutli-threaded (SMT) - Provides two logical processors for each physical core. Each logical processor has its own CPU state, but the execution engine and onboard cache are shared. This implies that one logical CPU can make progress while another is stalled (due to a cache miss or branch misprediction). 
3. Heterogeneous - Supported by ARM versions of Windows. In this design not all processor cores are identical in their capabilities, yet unlike pure heteregeneous multi-processing, they are still able to execute the same instructions. 
4. Non-uniform Memory Access (NUMA) - Processors are grouped into similar units called nodes. Each node has its own processors and memory and is connected to the larger system through a cache-coherent interconnect bus. Each node still has access to shared memory, however, accessing node-local memory serves to be faster and preffered. The system attempts to schedule threads on processors that are in the same node as the memory being used. 

Windows does make use of *heterogeneous scheduling policies* that allow threads to pick and choose between a policy that satisfies their needs and will interact with the scheduler and power manager to best support it. Windows also keeps track of the total number of processors, number of idle, busy etc. in a bitmask (*affinity mask*) that is the same number of bits as the native data type of the machine (32 or 64-bit). The actual number of licensed processors can be seen in *%SystemRoot%\ServiceProfiles\LocalService\AppData\Local\Microsoft\WSLicense\tokens.dat* in the variable *kernel-RegisteredProcessors*.